{% load static %}

<!-- Componente de Linha do Tempo -->
{% if linhas_tempo %}
<div class="linhas-tempo-container">
    {% for linha_data in linhas_tempo %}
    <section class="linha-tempo-section">
        <!-- Header da Linha do Tempo -->
        <h2 class="linha-tempo-titulo">Linha do Tempo</h2>

        <!-- Carrossel com notícias da linha do tempo -->
        {% if linha_data.noticias %}
        <div class="linha-tempo-wrapper">
            <div class="linha-tempo-carrossel" id="linhaTempoCarrossel{{ forloop.counter }}" dir="ltr" data-index="{{ forloop.counter }}">
                    {% for noticia_item in linha_data.noticias|dictsort:"data_publicacao" %}
                    <article class="carrossel-card {% if noticia_item.slug == noticia.slug %}carrossel-card-atual{% endif %}" data-slug="{{ noticia_item.slug }}" data-index="{{ forloop.counter0 }}">
                        <a href="{% url 'noticia_detalhe' noticia_item.slug %}" class="carrossel-link">
                            {% if noticia_item.imagem %}
                            <div class="carrossel-imagem">
                                <img src="{{ noticia_item.imagem.url }}" alt="{{ noticia_item.titulo }}">
                            </div>
                            {% endif %}

                            <div class="carrossel-conteudo">
                                <span class="carrossel-categoria">{{ noticia_item.categoria.nome }}</span>
                                <h4 class="carrossel-titulo">{{ noticia_item.titulo }}</h4>
                                <time class="carrossel-data">{{ noticia_item.data_publicacao|date:"d/m/Y" }}</time>
                            </div>
                        </a>
                    </article>
                {% endfor %}
            </div>

            <!-- Indicadores de paginação -->
            <div class="linha-tempo-indicators" id="indicators{{ forloop.counter }}"></div>
        </div>
        {% endif %}
    </section>
    {% endfor %}
</div>

<script>
// Script para funcionalidade do carrossel de linha do tempo
(function() {
    'use strict';

    function createIndicators(carrossel, indicatorsContainer) {
        const cards = carrossel.querySelectorAll('.carrossel-card');
        const totalCards = cards.length;

        // Limpar indicadores existentes
        indicatorsContainer.innerHTML = '';

        // Criar indicadores
        for (let i = 0; i < totalCards; i++) {
            const dot = document.createElement('div');
            dot.className = 'indicator-dot';
            dot.setAttribute('data-index', i);
            indicatorsContainer.appendChild(dot);
        }
    }

    function updateIndicators(carrossel, indicatorsContainer) {
        const cards = carrossel.querySelectorAll('.carrossel-card');
        const dots = indicatorsContainer.querySelectorAll('.indicator-dot');
        const totalCards = cards.length;

        if (totalCards === 0) return;

        // Encontrar qual card está mais centralizado
        const carrosselRect = carrossel.getBoundingClientRect();
        const carrosselCenter = carrosselRect.left + carrosselRect.width / 2;

        let closestIndex = 0;
        let closestDistance = Infinity;

        cards.forEach((card, index) => {
            const cardRect = card.getBoundingClientRect();
            const cardCenter = cardRect.left + cardRect.width / 2;
            const distance = Math.abs(cardCenter - carrosselCenter);

            if (distance < closestDistance) {
                closestDistance = distance;
                closestIndex = index;
            }
        });

        // Atualizar classes dos indicadores
        dots.forEach((dot, index) => {
            dot.classList.remove('active', 'near');

            if (index === closestIndex) {
                dot.classList.add('active');
            } else if (totalCards > 5) {
                // Lógica de proximidade para mais de 5 items (estilo Instagram)
                const distance = Math.abs(index - closestIndex);
                if (distance === 1) {
                    dot.classList.add('near');
                }
            }
        });
    }

    function initLinhaTempoCarrossel() {
        const carrosseis = document.querySelectorAll('.linha-tempo-carrossel');

        carrosseis.forEach((carrossel) => {
            const carrosselIndex = carrossel.getAttribute('data-index');
            const indicatorsContainer = document.getElementById('indicators' + carrosselIndex);

            if (!indicatorsContainer) return;

            // Criar indicadores
            createIndicators(carrossel, indicatorsContainer);

            // Encontrar o card atual e centralizar instantaneamente
            const cardAtual = carrossel.querySelector('.carrossel-card-atual');

            if (cardAtual) {
                // Usar scrollLeft direto para centralizar sem animação
                const carrosselRect = carrossel.getBoundingClientRect();
                const cardRect = cardAtual.getBoundingClientRect();
                const offset = cardRect.left - carrosselRect.left - (carrosselRect.width / 2) + (cardRect.width / 2);
                carrossel.scrollLeft += offset;
            }

            // Atualizar indicadores após centralizar
            setTimeout(() => {
                updateIndicators(carrossel, indicatorsContainer);
            }, 100);

            // Atualizar indicadores ao rolar
            carrossel.addEventListener('scroll', () => {
                updateIndicators(carrossel, indicatorsContainer);
            });
        });
    }

    // Inicializar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLinhaTempoCarrossel);
    } else {
        initLinhaTempoCarrossel();
    }
})();
</script>
{% endif %}

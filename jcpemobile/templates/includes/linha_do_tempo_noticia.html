{% load static %}

<!-- Componente de Linha do Tempo -->
{% if linhas_tempo %}
<div class="linhas-tempo-container">
    {% for linha_data in linhas_tempo %}
    <section class="linha-tempo-section">
        <!-- Header da Linha do Tempo -->
        <div class="linha-tempo-header">
            <h2 class="linha-tempo-titulo">
                Linha do Tempo
            </h2>
        </div>

        <!-- Scroll horizontal com as notícias -->
        <div class="linha-tempo-scroll-container" id="linhaTempoScroll{{ forloop.counter }}">
            <div class="linha-tempo-scroll">
                <!-- Slide 1: Primeiras 2 notícias -->
                <div class="linha-tempo-slide" data-index="0">
                    {% for noticia_item in linha_data.noticias|slice:":2" %}
                    <article class="linha-tempo-card">
                        {% if noticia_item.imagem %}
                        <img src="{{ noticia_item.imagem.url }}"
                             alt="{{ noticia_item.titulo }}"
                             class="linha-tempo-card-imagem">
                        {% endif %}

                        <div class="linha-tempo-card-conteudo">
                            <span class="linha-tempo-card-categoria">{{ noticia_item.categoria.nome }}</span>

                            <h3 class="linha-tempo-card-titulo">
                                <a href="{% url 'noticia_detalhe' noticia_item.slug %}">
                                    {{ noticia_item.titulo }}
                                </a>
                            </h3>

                            <div class="linha-tempo-card-data">
                                <span>{{ noticia_item.data_publicacao|date:"d M, Y" }}</span>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>

                <!-- Slide 2: Próximas 2 notícias -->
                {% if linha_data.noticias|length > 2 %}
                <div class="linha-tempo-slide" data-index="1">
                    {% for noticia_item in linha_data.noticias|slice:"2:4" %}
                    <article class="linha-tempo-card">
                        {% if noticia_item.imagem %}
                        <img src="{{ noticia_item.imagem.url }}"
                             alt="{{ noticia_item.titulo }}"
                             class="linha-tempo-card-imagem">
                        {% endif %}

                        <div class="linha-tempo-card-conteudo">
                            <span class="linha-tempo-card-categoria">{{ noticia_item.categoria.nome }}</span>

                            <h3 class="linha-tempo-card-titulo">
                                <a href="{% url 'noticia_detalhe' noticia_item.slug %}">
                                    {{ noticia_item.titulo }}
                                </a>
                            </h3>

                            <div class="linha-tempo-card-data">
                                <span>{{ noticia_item.data_publicacao|date:"d M, Y" }}</span>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Slide 3: Próximas 2 notícias -->
                {% if linha_data.noticias|length > 4 %}
                <div class="linha-tempo-slide" data-index="2">
                    {% for noticia_item in linha_data.noticias|slice:"4:6" %}
                    <article class="linha-tempo-card">
                        {% if noticia_item.imagem %}
                        <img src="{{ noticia_item.imagem.url }}"
                             alt="{{ noticia_item.titulo }}"
                             class="linha-tempo-card-imagem">
                        {% endif %}

                        <div class="linha-tempo-card-conteudo">
                            <span class="linha-tempo-card-categoria">{{ noticia_item.categoria.nome }}</span>

                            <h3 class="linha-tempo-card-titulo">
                                <a href="{% url 'noticia_detalhe' noticia_item.slug %}">
                                    {{ noticia_item.titulo }}
                                </a>
                            </h3>

                            <div class="linha-tempo-card-data">
                                <span>{{ noticia_item.data_publicacao|date:"d M, Y" }}</span>
                            </div>
                        </div>
                    </article>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Indicadores de navegação (bolinhas) -->
            <div class="linha-tempo-indicators" data-container-id="linhaTempoScroll{{ forloop.counter }}">
                <span class="indicator active" data-index="0"></span>
                {% if linha_data.noticias|length > 2 %}
                <span class="indicator" data-index="1"></span>
                {% endif %}
                {% if linha_data.noticias|length > 4 %}
                <span class="indicator" data-index="2"></span>
                {% endif %}
            </div>
        </div>
    </section>
    {% endfor %}
</div>

<script>
// Script para funcionalidade de scroll na linha do tempo
(function() {
    'use strict';

    function initLinhaTempoScroll() {
        const indicatorGroups = document.querySelectorAll('.linha-tempo-indicators');

        indicatorGroups.forEach((indicatorGroup) => {
            const containerId = indicatorGroup.getAttribute('data-container-id');
            const container = document.getElementById(containerId);
            if (!container) return;

            const slides = container.querySelectorAll('.linha-tempo-slide');
            const indicators = indicatorGroup.querySelectorAll('.indicator');
            
            if (slides.length === 0) return;

            let currentIndex = 0;

            // Função para rolar para um slide específico
            function scrollToCard(index) {
                const slide = slides[index];
                if (!slide) return;

                slide.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'start'
                });

                updateIndicators(index);
            }

            // Atualizar indicadores ativos
            function updateIndicators(index) {
                indicators.forEach((indicator, i) => {
                    indicator.classList.toggle('active', i === index);
                });
                currentIndex = index;
            }

            // Click nos indicadores
            indicators.forEach((indicator, index) => {
                indicator.addEventListener('click', (e) => {
                    e.preventDefault();
                    scrollToCard(index);
                });
            });

            // Observar quando um slide entra na visão
            const scrollContainer = container;
            const observerOptions = {
                root: scrollContainer,
                threshold: 0.5,
                rootMargin: '0px'
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && entry.intersectionRatio >= 0.5) {
                        const index = parseInt(entry.target.getAttribute('data-index'));
                        if (!isNaN(index) && index !== currentIndex) {
                            updateIndicators(index);
                        }
                    }
                });
            }, observerOptions);

            slides.forEach(slide => observer.observe(slide));

            // Também detectar scroll manual
            let scrollTimeout;
            scrollContainer.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    // Encontrar qual slide está mais visível
                    let mostVisible = null;
                    let maxVisibility = 0;

                    slides.forEach((slide, index) => {
                        const rect = slide.getBoundingClientRect();
                        const containerRect = scrollContainer.getBoundingClientRect();
                        
                        const visibleWidth = Math.min(rect.right, containerRect.right) - Math.max(rect.left, containerRect.left);
                        const visibility = visibleWidth / rect.width;

                        if (visibility > maxVisibility) {
                            maxVisibility = visibility;
                            mostVisible = index;
                        }
                    });

                    if (mostVisible !== null && mostVisible !== currentIndex) {
                        updateIndicators(mostVisible);
                    }
                }, 100);
            });
        });
    }

    // Inicializar quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLinhaTempoScroll);
    } else {
        initLinhaTempoScroll();
    }
})();
</script>
{% endif %}
